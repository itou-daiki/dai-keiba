# AI 競馬予想 EVシステム (AI Horse Racing EV System)

本アプリケーションは、**LightGBM** を用いた機械学習モデルにより、中央競馬（JRA）および地方競馬のレース結果を予測し、回収率（Expected Value: EV）の高い馬を自動抽出する**AI予想システム**です。
スクレイピング、特徴量エンジニアリング、モデル学習、そしてWebによる可視化までを一貫して提供します。

## 🎯 目的
- **AIによる客観的評価**: 過去の膨大なレースデータ（着順、タイム、上がり3F、馬場状態など）を学習し、人間のバイアスを排除した「勝つ確率（Top 3入着率）」を算出します。
- **EV（期待値）の最大化**: AIの予測確率と現在のオッズ、および予想家の印を組み合わせて「期待値」を計算し、過小評価されている穴馬（妙味馬）を発見します。

## 🚀 主な機能
1.  **自動スクレイピング (Data Pipeline)**
    - `netkeiba.com` から過去のレース結果、競走馬の履歴、当日の出馬表を自動収集します。
    - 直近1週間（本日+7日間）の全レース情報を自動取得可能です。
2.  **特徴量エンジニアリング (ML Pipeline)**
    - 過去走の着順や通過順位（脚質）に対して「時間減衰（Time Decay）」加重平均を適用し、最新の調子を敏感に反映。
    - 天気、馬場状態、斤量、騎手、馬体重などの詳細データを数値化して学習に利用。
3.  **LightGBM 予測モデル**
    - 高速かつ高精度なLightGBM（勾配ブースティング決定木）を採用。
    - 不均衡データに対応し、3着以内に入る確率（複勝圏内率）をスコア化します。
4.  **インタラクティブ Web UI (Streamlit)**
    - **レース分析**: 開催中のレースを選択し、AIスコア、予想印、オッズ、EVを一目で比較。
    - **データ可視化**:
        - **レーダーチャート**: スピード、スタミナ、瞬発力などの能力を視覚化（※擬似スコア）。
        - **多軸ラインチャート**: 過去5走の着順と上がり3Fの推移をグラフで分析。
    - **フィルタリング**: 会場や日付でレースを絞り込み可能。

## 🛠️ インストール手順

### 前提条件
- Python 3.8 以上
- Anaconda 環境（推奨）

### セットアップ
1. リポジトリをクローンまたはダウンロードします。
2. 必要なライブラリをインストールします。
   ```bash
   pip install -r requirements.txt
   ```

## 🖥️ 使い方

### 1. アプリケーションの起動
以下のコマンドでWebインターフェース（Streamlit）を起動します。
```bash
python -m streamlit run public_app.py
```
ブラウザが自動的に開き、`http://localhost:8501` でアプリにアクセスできます。

### 2. 分析フロー
1.  **サイドバー操作**:
    - 「日付を選択」ドロップダウンから、分析したい開催日を選びます。
    - データがない場合は「レース一覧を更新 (今後1週間)」ボタンを押して、最新の出馬表を取得してください。
2.  **レース選択**:
    - サイドバーの「レース選択」から分析したいレースを選びます。
3.  **AI分析**:
    - メイン画面の「AI分析を実行する」ボタンをクリックします。
    - バックグラウンドでスクレイピングとAI予測が実行されます。
4.  **結果の確認**:
    - **推奨買い目**: EVの高い「狙い目」の馬が表示されます。
    - **詳細データ**: 全出走馬のスコア、EV、オッズが表形式で表示されます。
    - **分析グラフ**: 各馬の能力や過去の傾向をグラフィカルに確認できます。

## 📁 ディレクトリ構造
- `public_app.py`: メインのWebアプリケーション（UI/推論ロジック）。
- `scraper/`: データ収集用スクリプト群。
    - `auto_scraper.py`: スケジュール取得やデータエンリッチメントの中核。
    - `race_scraper.py`: 個別レース・馬柱の詳細スクレイピング。
- `ml/`: 機械学習関連。
    - `feature_engineering.py`: 特徴量の生成・加工。
    - `train_model.py`: モデルの学習と保存。
    - `lgbm_model.pkl`: 学習済みAIモデル。
- `todays_data.json`: 取得した出馬表データのキャッシュ。
- `processed_data.csv`: 学習用・分析用に加工されたデータセット。