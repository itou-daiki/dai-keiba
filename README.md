# 🏇 AI競馬予測システム (dai-keiba)

**最終更新:** 2026-01-02
**バージョン:** 2.2.0
**目的:** 競馬の**1着（勝馬）予測**による投資回収率最大化

---

## 📋 目次

1. [システム概要](#システム概要)
2. [主要機能](#主要機能)
3. [分析モード](#分析モード)
4. [技術仕様](#技術仕様)
5. [特徴量詳細](#特徴量詳細)
6. [インストール・セットアップ](#インストールセットアップ)
7. [使用方法](#使用方法)
8. [モデル性能](#モデル性能)
9. [トラブルシューティング](#トラブルシューティング)

---

## 🎯 システム概要

### コンセプト

**「AIの予測確率」×「あなたの相馬眼（予想印）」×「オッズ」= 期待値(EV)**

本システムは、機械学習（LightGBM）を用いて**1着確率**を算出し、期待値（Expected Value）がプラスの馬券を見つけ出します。通常馬券のほか、**WIN5**（5重勝単勝式）や**トリプル馬単**（3重勝馬単）の予測にも対応しています。

### 主な特長

- ✅ **2026年シーズン対応:** 最新の開催日程に対応
- ✅ **データリーク完全防止:** shift(1)による厳密な時系列処理
- ✅ **JRA/NAR別最適化:** 中央競馬・地方競馬で異なるモデル・パラメータ
- ✅ **60-70個の高品質特徴量:** 競馬専門知識を深く反映（血統、脚質バイアス、オッズ偏差など）
- ✅ **多彩な分析モード:** 個別レースから過去データの傾向分析まで
- ✅ **強制再取得モード:** スクレイピング漏れやオッズ更新に対応

### 対象ユーザー

- 💰 **投資家:** 期待値プラスの馬券で長期的な利益を追求
- 🎓 **データサイエンティスト:** 競馬予測の技術的チャレンジを楽しむ
- 🏇 **競馬ファン:** AIと自分の予想を組み合わせて的中率UP

---

## ⚡ 主要機能

### 1. AI予測機能

- **1着確率の算出:** 過去14万件以上のレースデータから学習
- **D指数 (Dai-Index):** AIスコア(30%) + 適性スコア(60%) + 血統スコア(10%) の複合指標
- **信頼度スコア:** 各予測の信頼性を0-100%で数値化（データ量や確率分布に基づく）

### 2. 特殊馬券予測

- **👑 WIN5予想:** 指定5レースの1着馬を予測し、買い目を生成
- **🎯 トリプル馬単予想:** 指定3レースの馬単（1-2着）を予測

### 3. データ管理

- **自動スクレイピング:** netkeiba.comから最新データ取得
- **強制再取得 (Force Mode):** 既存データを無視して最新情報を再取得（オッズ更新などに有効）
- **オッズバイアス補正:** 現在オッズとAIスコアをブレンドして精度を向上

---

## 🔍 分析モード

アプリ (`public_app.py`) には以下の分析モードが搭載されています。

### 1. 🔍 個別レース分析
特定のレースIDを指定して、詳細なAI予測、適性スコア、血統背景、期待値を表示します。

### 2. 💎 堅いレースを探す (一括分析)
その日の全レースを一括で分析し、**信頼度が高い「堅いレース」**を抽出します。
- **オッズ指標:** 1-2番人気のオッズ差 (Gap 1-2) や標準偏差を表示
- **フィルタリング:** 開催地や信頼度閾値で絞り込み可能

### 3. 📊 過去のレース分析 (データベース)
蓄積された全過去データから、オッズ差や信頼度に基づいて「堅いレース」の傾向を分析します。
- **フィルタ機能:** 日付範囲、開催地でデータを絞り込み可能
- **CSV出力:** 分析結果をCSV形式でダウンロード可能

---

## 🔧 技術仕様

### システム要件

- **Python:** 3.8以上
- **必須ライブラリ:**
  - pandas, numpy（データ処理）
  - lightgbm（機械学習）
  - streamlit（UI）
  - selenium（スクレイピング）
  - optuna（ハイパーパラメータ最適化）

### 機械学習モデル

| 項目 | 仕様 |
|------|------|
| アルゴリズム | LightGBM Gradient Boosting |
| タスク | Binary Classification (1着 = 1, その他 = 0) |
| 目的関数 | Binary Cross-Entropy |
| 評価指標 | AUC (ROC曲線下面積) |
| 確率較正 | Isotonic Regression |

---

## 📊 特徴量詳細

### 全特徴量一覧（主要抜粋）

#### 1. 過去成績ベース（時間減衰加重平均）
**重み:** `[0.50, 0.25, 0.13, 0.08, 0.04]` （前走重視）

- `weighted_avg_rank`: 加重平均着順
- `weighted_avg_last_3f`: 加重平均上り3F
- `weighted_avg_speed`: 加重平均速度

#### 2. 適性スコア（Global History）
過去3年間の全データを参照し、当該条件への適性を算出。

- `jockey_compatibility`: 騎手×馬の相性
- `course_compatibility`: 芝/ダート適性
- `distance_compatibility`: 距離区分（短距離/マイル/中距離/長距離）適性

#### 3. オッズ・市場指標
- `odds`: 単勝オッズ
- `odds_gap`: 1番人気と2番人気のオッズ乖離
- `odds_std`: 上位人気のオッズ標準偏差（混戦度合い）

---

## 🚀 インストール・セットアップ

### 1. リポジトリクローン

```bash
git clone https://github.com/yourusername/dai-keiba.git
cd dai-keiba
```

### 2. 依存関係インストール

```bash
pip install -r requirements.txt
```

### 3. Chromeドライバー設定
`scraper/auto_scraper.py` 内の `CHROMEDRIVER_PATH` を環境に合わせて設定してください。

---

## 💻 使用方法

### 管理画面 (Admin App)

データの収集やモデルの再学習を行います。

```bash
streamlit run app/admin_app.py
```

- **スクレイピング:** JRA/NAR、対象期間、対象場を選択してデータ取得。
- **⚠️ 既存データを上書きする:** チェックを入れると、保存済みのレースも強制的に再取得します（オッズが0の場合などに有効）。

### 予想アプリ (Public App)

AIによる予想を行います。

```bash
streamlit run app/public_app.py
```

1. **開催モード選択:** JRA / NAR
2. **日付選択:** 分析したい日付を選択
3. **機能選択:**
   - 個別分析
   - 一括分析（堅いレース抽出）
   - 過去分析（データベース）
   - WIN5 / トリプル馬単

---

## 📈 モデル性能

### JRAモデル（lgbm_model.pkl）

**学習データ:** 14万件超（2020-2025年）

| 指標 | 値 | 感想 |
|------|---|------|
| AUC | **0.8909** | 非常に優秀。勝ち馬を高い確率で上位にランク付けできています。 |
| Precision | 0.7266 | 「買い」と判断した馬の約73%が好走。 |

### NARモデル（lgbm_model_nar.pkl）

| 指標 | 値 |
|------|---|
| AUC | **0.8500** | 地方競馬特有の荒れやすさを含みつつも高精度。 |

---

## ⚠️ トラブルシューティング

### Q1. オッズが0.0になる・分析結果が0件になる
**A.** データのスクレイピングが不完全な可能性があります。
1. 管理画面 (`admin_app.py`) で「⚠️ 既存データを上書きする」にチェックを入れる。
2. 対象日を指定して再度スクレイピングを実行してください。

### Q2. 2026年のデータが取れない
**A.** 管理画面の「年」プルダウンに「2026」が追加されているか確認してください。最新版では対応済みです。

### Q3. AIスコアが表示されない
**A.** `public_app.py` の一括分析などで `AI_Score` カラムが表示されない場合、最新のコード（v2.2.0以降）を使用しているか確認してください。列名の不一致修正が含まれています。



