# AI 競馬予想 EVシステム (AI Horse Racing EV System)

## 📌 概要
本アプリケーションは、**LightGBM** を用いた機械学習モデルにより、中央競馬（JRA）のレース結果を予測し、回収率（Expected Value: EV）の高い馬を自動抽出する**AI予想システム**です。
管理画面での「データ収集・モデル学習」から、公開画面での「リアルタイム予想・分析」までを一貫して提供します。

---

## �️ システム構成 & アーキテクチャ

システムは大きく分けて以下の2つのアプリケーションと、バックエンドのパイプラインで構成されています。

### 1. 🛠️ 管理アプリケーション (`scraper/admin_app.py`)
**役割**: データ収集、モデル学習、運用管理
- **スクレイピング機能**:
    - 指定した期間のレース結果を `netkeiba.com` から自動収集。
    - **高速化**: 一度取得した馬の過去データはメモリにキャッシュし、通信回数を劇的に削減（N+1問題の解消）。
- **MLOps機能**:
    - **モデル学習**: 最新の `database.csv` を基にLightGBMモデルを学習。
    - **チューニング**: Optunaを用いたハイパーパラメータの自動最適化。
    - **実験管理**: MLflowにより、過去の実験履歴（パラメータ、AUC、Accuracy）を記録・可視化。

### 2. 🌍 公開アプリケーション (`public_app.py`)
**役割**: ユーザー向け予想提供、レース分析
- **リアルタイム予想**:
    - 当日の出馬表をワンクリックで取得し、学習済みモデルで瞬時に「3着以内率」を予測。
- **EV（期待値）計算**:
    - `(AI勝率 × 予想印補正 × 現在オッズ) - 1.0` の計算式で、過小評価されている「狙い目の馬」を抽出。
    - **安全フィルタ**: AI予測確率が **8%未満** の馬は、オッズが高くても推奨から除外（EV=-1.0）。
- **可視化**:
    - レーダーチャート（能力分析）や過去走の推移グラフで、直感的なデータ分析が可能。

---

## 🔄 処理の流れ (Data & ML Pipeline)

### Phase 1: データ収集 (Scraping)
1. **レース一覧取得**: 指定期間または「今後1週間」のスケジュールを取得。
2. **詳細データ収集**:
    - 各レースの着順、タイム、天候、馬場状態などを取得。
    - **特徴**: 馬ごとの「過去走データ（最大全履歴）」も同時に取得し、特徴量生成に利用。
3. **データ保存**: `database.csv` に生のスクレイピング結果を蓄積。

### Phase 2: 特徴量エンジニアリング (Feature Engineering)
`ml/feature_engineering.py` にて、生データを学習用データ(`processed_data.csv`)に変換します。

- **時間減衰加重平均 (Time Decay Weighted Average)**:
    - 過去5走の成績（着順、上がり3F、馬体重など）に対し、直近のレースほど重みが大きくなるように加重平均を算出。
    - `Wait = exp(-0.5 * (i-1))`
    - これにより、「昔は強かったが今は不調」な馬や「急成長中」の馬のトレンドを捉えます。
- **補完処理**:
    - 初出走やデータ欠損がある場合、平均的な値（着順=18位相当、上がり=40秒など）で埋めることで、モデルの誤作動を防ぎます。
- **カテゴリカル変数の数値化**:
    - 天候（晴=1, 雨=3...）、馬場状態（良=1, 重=3...）、コース区分などを数値コードに変換。

### Phase 3: モデル学習 (Modeling)
`ml/train_model.py` にて学習を実行。

- **アルゴリズム**: LightGBM (Gradient Boosting Decision Tree)
- **目的変数**: `target_top3` (3着以内に入ったかどうか)
- **評価指標**: AUC (Area Under the Curve) を最大化するように学習。
- **出力**: `ml/models/lgbm_model.pkl` (実稼働用モデル)

---

## 📊 EV算出ロジック詳細

本システム最大の特徴である「期待値 (EV)」は以下の式で計算されます。

$$
EV = (P_{ai} \times W_{mark} \times Odds) - 1.0
$$

- **$P_{ai}$ (AIスコア)**: LightGBMが算出した「3着以内に入る確率」。
- **$W_{mark}$ (予想印補正)**:
    - ユーザーが入力した印に応じて確率をブーストします。
    - ◎: 1.5倍, ◯: 1.2倍, ▲: 1.1倍, △: 1.05倍
- **$Odds$ (現在オッズ)**:
    - リアルタイムオッズ、またはユーザー入力オッズ。
    - 取得できない場合は「0.0」となり計算対象外になります。

**⚠️ 安全装置**:
$P_{ai}$ が **8%未満** の場合、どれだけオッズが高くても $EV = -1.0$ 固定となり、無謀な穴狙いを防ぎます。

---

## � 使い方

### 1. アプリケーションの起動
```bash
# 管理画面 (ポート 8501)
python -m streamlit run scraper/admin_app.py

# 公開画面 (ポート 8502)
python -m streamlit run public_app.py
```

### 2. 運用フロー
1. **[管理画面]** で `database.csv` を最新化し、「学習開始」ボタンでモデルを更新。
2. **[公開画面]** サイドバーの「最新モデルを再読み込み」をクリック。
3. **[公開画面]** で「レース一覧を更新」し、対象レースを選択して「分析する」を実行。

---

## 📁 ディレクトリ構造
- `public_app.py`: ユーザー向けWebアプリ
- `scraper/`:
    - `admin_app.py`: 管理者向けWebアプリ
    - `auto_scraper.py`: スクレイピング統括ロジック（キャッシュ機能付き）
    - `race_scraper.py`: ページ解析ロジック
- `ml/`:
    - `feature_engineering.py`: 特徴量生成・前処理
    - `train_model.py`: 学習・推論ロジック
    - `models/`: 学習済みモデル保存先