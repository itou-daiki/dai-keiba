name: 定期レースデータ取得

on:
  # 毎日午前3時（JST 12時）に実行
  schedule:
    - cron: '0 3 * * *'

  # 手動実行も可能
  workflow_dispatch:
    inputs:
      year:
        description: '取得する年'
        required: false
        default: ''
      month:
        description: '取得する月'
        required: false
        default: ''

jobs:
  scrape:
    runs-on: ubuntu-latest

    steps:
      - name: チェックアウト
        uses: actions/checkout@v3

      - name: Python環境のセットアップ
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Chromeとドライバーのインストール
        run: |
          sudo apt-get update
          sudo apt-get install -y chromium-browser chromium-chromedriver

      - name: Python依存関係のインストール
        run: |
          cd scraper
          pip install -r requirements.txt

      - name: 年月の設定
        id: set-date
        run: |
          if [ -z "${{ github.event.inputs.year }}" ]; then
            YEAR=$(date +%Y)
            MONTH=$(date +%m)
          else
            YEAR=${{ github.event.inputs.year }}
            MONTH=${{ github.event.inputs.month }}
          fi
          echo "year=$YEAR" >> $GITHUB_OUTPUT
          echo "month=$MONTH" >> $GITHUB_OUTPUT
          echo "取得対象: ${YEAR}年${MONTH}月"

      - name: レースURL取得
        run: |
          cd scraper
          python3 1_fetch_race_urls.py
        env:
          SCRAPE_YEAR: ${{ steps.set-date.outputs.year }}
          SCRAPE_MONTH: ${{ steps.set-date.outputs.month }}

      - name: HTML取得
        run: |
          cd scraper
          python3 2_fetch_html.py
        env:
          SCRAPE_YEAR: ${{ steps.set-date.outputs.year }}
          SCRAPE_MONTH: ${{ steps.set-date.outputs.month }}

      - name: CSV生成
        run: |
          cd scraper
          python3 3_parse_to_csv.py
        env:
          SCRAPE_YEAR: ${{ steps.set-date.outputs.year }}
          SCRAPE_MONTH: ${{ steps.set-date.outputs.month }}

      - name: データ容量確認
        run: |
          echo "データディレクトリのサイズ:"
          du -sh scraper/data/
          echo ""
          echo "CSV一覧:"
          ls -lh scraper/data/csv/ 2>/dev/null || echo "CSVなし"

      - name: 変更をコミット
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add scraper/data/
          git diff --quiet && git diff --staged --quiet || (
            git commit -m "自動更新: レースデータ取得 (${{ steps.set-date.outputs.year }}/${{ steps.set-date.outputs.month }})" &&
            git push
          )

      - name: 実行結果の通知
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "✓ スクレイピング成功"
          else
            echo "✗ スクレイピング失敗"
          fi
